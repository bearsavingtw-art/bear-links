<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bear è²¡å‹™è¨ºæ–·å®¤ 6.3</title>
    <link rel="icon" href="favicon.png" type="image/png">
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#fcfbf9">
    <link rel="apple-touch-icon" href="logo.png">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600&family=Noto+Serif+TC:wght@400;600&family=Playfair+Display:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            /* Bear.saving å“ç‰Œè‰²ç³» */
            --bg-color: #fcfbf9;        /* ç±³ç™½èƒŒæ™¯ */
            --text-primary: #5a4d41;    /* æ·±æ£•æ–‡å­— */
            --text-secondary: #968c83;  /* æ·ºæ£•å‰¯æ¨™ */
            --accent: #b08d85;          /* ä¹¾ç‡¥ç«ç‘°è‰² */
            --input-bg: #fdfbf7;        
            --white: #ffffff;
            --shadow: 0 10px 30px rgba(90, 77, 65, 0.08);
            --danger: #e57373;          
            --success: #81c784;         
            --gold: #d4a373;            /* ç…å­é‡‘ */
        }

        body {
            font-family: 'Montserrat', 'Noto Serif TC', serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0; padding: 0;
            min-height: 100vh;
            display: flex; flex-direction: column;
        }

        /* å°è¦½åˆ— */
        nav {
            padding: 20px 30px; display: flex; justify-content: space-between; align-items: center;
            background: rgba(252, 251, 249, 0.95); position: fixed; top: 0; width: 100%; z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .nav-logo { font-family: 'Playfair Display', serif; font-size: 1.2rem; font-weight: 600; color: var(--text-primary); text-decoration: none; }
        .nav-back { font-size: 0.9rem; color: var(--text-secondary); text-decoration: none; display: flex; align-items: center; gap: 5px; transition: 0.3s; }
        .nav-back:hover { color: var(--accent); }

        /* ä¸»å®¹å™¨ */
        .main-wrapper {
            flex: 1; display: flex; justify-content: center; align-items: center;
            padding: 100px 20px 40px; 
        }

        .container {
            background-color: var(--white);
            padding: 40px 30px;
            border-radius: 20px;
            box-shadow: var(--shadow);
            width: 100%; max-width: 600px;
            text-align: center;
            position: relative;
            border: 1px solid rgba(176, 141, 133, 0.1);
        }

        h1 { font-family: 'Playfair Display', serif; font-size: 1.8rem; margin-bottom: 25px; color: var(--accent); }

        /* è¼¸å…¥å€å¡Š */
        .question { margin-bottom: 25px; text-align: left; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-primary); }
        
        input, select { 
            width: 100%; padding: 12px; 
            border: 1px solid #e0e0e0; border-radius: 10px; 
            box-sizing: border-box; font-size: 1rem; outline: none; 
            background-color: var(--input-bg); color: var(--text-primary);
            font-family: 'Montserrat', sans-serif; transition: 0.3s;
        }
        input:focus, select:focus { border-color: var(--accent); background: #fff; }

        /* é¸é …å¡ç‰‡ */
        .options { display: flex; gap: 12px; margin-top: 10px; }
        .option-card {
            flex: 1; padding: 15px 10px;
            border: 1px solid #e0e0e0; border-radius: 12px;
            cursor: pointer; transition: all 0.3s;
            background-color: var(--input-bg); color: var(--text-secondary);
        }
        .option-card b { display: block; margin-bottom: 4px; font-size: 1rem; color: var(--text-primary); }
        .option-card small { font-size: 0.8rem; }
        .option-card.selected { background-color: var(--accent); border-color: var(--accent); }
        .option-card.selected b, .option-card.selected small { color: var(--white); }

        /* æŒ‰éˆ•æ¨£å¼ */
        .btn { 
            background: var(--text-primary); color: white; border: none; 
            padding: 15px 30px; border-radius: 50px; font-size: 1rem; cursor: pointer; 
            width: 100%; margin-top: 15px; font-weight: 600; transition: 0.3s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); letter-spacing: 1px;
        }
        .btn:hover { background: var(--accent); transform: translateY(-2px); }
        .btn-outline {
            background: transparent; border: 1px dashed var(--accent); color: var(--accent);
            width: 100%; padding: 10px; border-radius: 10px; cursor: pointer; font-size: 0.9rem;
            transition: 0.3s;
        }
        .btn-outline:hover { background: var(--input-bg); }
        .btn-warning { background: var(--danger); }
        .btn-info { background: #78909c; }

        /* éš±è—/é¡¯ç¤º */
        .hidden { display: none; }

        /* --- [æ–°å¢] å‹•ç‰©äººæ ¼å¡ç‰‡ --- */
        .animal-card {
            background: #fff; border: 2px solid var(--accent);
            border-radius: 20px; padding: 30px 20px;
            margin-bottom: 30px; position: relative;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(176, 141, 133, 0.15);
        }
        .animal-emoji { font-size: 4rem; display: block; margin-bottom: 10px; animation: popIn 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .animal-title { font-size: 1.4rem; font-weight: 700; color: var(--text-primary); margin-bottom: 10px; font-family: 'Playfair Display', serif; }
        .animal-desc { font-size: 0.95rem; color: var(--text-secondary); line-height: 1.6; text-align: left; }
        .animal-tag { 
            display: inline-block; background: var(--input-bg); 
            color: var(--accent); padding: 5px 15px; border-radius: 50px; 
            font-size: 0.8rem; font-weight: 600; margin-bottom: 15px;
        }
        @keyframes popIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* --- [æ–°å¢] è™•æ–¹ç±¤æ¨£å¼ --- */
        .prescription-container {
            margin-top: 30px; text-align: left;
            background: #fffafa; border: 1px solid #ffebee;
            border-radius: 15px; padding: 25px;
            position: relative;
        }
        .prescription-header {
            font-weight: 700; color: var(--danger); font-size: 1.1rem;
            margin-bottom: 15px; display: flex; align-items: center; gap: 8px;
        }
        .prescription-text { font-size: 0.95rem; color: var(--text-primary); margin-bottom: 20px; line-height: 1.6; }
        .product-link-btn {
            display: block; width: 100%; padding: 12px;
            background: var(--text-primary); color: #fff;
            text-align: center; text-decoration: none; border-radius: 50px;
            font-weight: 600; transition: 0.3s;
        }
        .product-link-btn:hover { background: var(--accent); }

        /* åœ–è¡¨èˆ‡é ç®— */
        .budget-card { background: var(--input-bg); border-radius: 15px; padding: 25px; margin-top: 20px; text-align: left; }
        .chart-container { position: relative; height: 250px; width: 100%; margin: 20px 0; display: flex; justify-content: center; }
        .budget-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; align-items: center; font-size: 0.95rem; }
        
        /* è² å‚µè¼¸å…¥ */
        .debt-item { background: var(--input-bg); padding: 20px; border-radius: 15px; margin-bottom: 15px; border: 1px dashed var(--accent); }
        .debt-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .grid-label { font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 4px; text-align: left; }

        /* ç¸½å ±å‘Šè¡¨æ ¼ */
        .full-report { text-align: left; background: #fff; padding: 20px; border-radius: 15px; border: 1px solid #eee; }
        .report-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px dashed #eee; font-size: 1rem; }
        .debt-table-wrapper { width: 100%; overflow-x: auto; margin-top: 15px; }
        .debt-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; min-width: 450px; }
        .debt-table th { background: var(--input-bg); text-align: left; padding: 10px; border-bottom: 2px solid var(--accent); color: var(--text-primary); }
        .debt-table td { padding: 10px; border-bottom: 1px solid #eee; color: var(--text-secondary); }
        .save-money { color: var(--success); font-weight: bold; }

    </style>
</head>
<body>

    <nav>
        <a href="index.html" class="nav-back"><i class="fas fa-arrow-left"></i> å›é¦–é </a>
        <a href="index.html" class="nav-logo">Bear.saving</a>
        <div style="width: 70px;"></div>
    </nav>

    <div class="main-wrapper">
        <div class="container" id="page1">
            <h1>Financial Diagnosis</h1>
            <p style="color:var(--text-secondary); margin-bottom:30px; font-size:0.9rem;">Bear è²¡å‹™è¨ºæ–·å®¤ 6.3 | äººæ ¼åˆ†æèˆ‡è™•æ–¹</p>

            <div id="quiz-form">
                
                <div class="question">
                    <label>1. ç›®å‰æœ‰ç„¡è² å‚µï¼Ÿ</label>
                    <select id="hasDebt" onchange="toggleDebtSection()">
                        <option value="no">ç„¡è² å‚µ (ä¸€èº«è¼•âœ¨)</option>
                        <option value="yes">æˆ‘æœ‰è² å‚µ (æƒ³é¢å°ğŸ’ª)</option>
                    </select>
                </div>

                <div id="emergency-fund-group" class="question">
                    <label>2. æ˜¯å¦å­˜æ»¿ 3-6 å€‹æœˆç”Ÿæ´»é å‚™é‡‘ï¼Ÿ</label>
                    <select id="hasEmergencyFund">
                        <option value="no">å°šæœªå­˜æ»¿</option>
                        <option value="yes">å·²ç¶“å­˜æ»¿äº†</option>
                    </select>
                </div>

                <div id="debt-input-group" style="display:none;">
                    <label>2. è² å‚µæ˜ç´°</label>
                    <div id="debt-list">
                        <div class="debt-item">
                            <div class="debt-grid">
                                <div><div class="grid-label">é …ç›®åç¨±</div><input type="text" class="d-name" placeholder="ä¾‹:å­¸è²¸"></div>
                                <div><div class="grid-label">å¹´åˆ©ç‡ %</div><input type="number" step="0.1" class="d-rate" placeholder="0.0"></div>
                                <div><div class="grid-label">æ¯æœˆç¹³æ¬¾</div><input type="number" class="d-pay" placeholder="0"></div>
                                <div><div class="grid-label">å‰©é¤˜æœŸæ•¸</div><input type="number" class="d-months" placeholder="0"></div>
                            </div>
                        </div>
                    </div>
                    <button class="btn-outline" onclick="addDebt()">ï¼‹ æ–°å¢è² å‚µé …ç›®</button>
                </div>

                <div class="question" style="margin-top:25px;">
                    <label>3. æ”¶å…¥æ€§è³ªï¼Ÿ</label>
                    <div class="options">
                        <div class="option-card selected" onclick="selectType('stable')" id="type-stable">
                            <b>ç©©å®šæ”¶å…¥</b><br><small>ä¸€èˆ¬ä¸Šç­æ—</small>
                        </div>
                        <div class="option-card" onclick="selectType('unstable')" id="type-unstable">
                            <b>ä¸ç©©å®šæ”¶å…¥</b><br><small>æ¥æ¡ˆ / æ¥­å‹™</small>
                        </div>
                    </div>
                </div>

                <div class="question">
                    <label>4. æ¯æœˆç¸½æ”¶å…¥</label>
                    <input type="number" id="monthlyIncome" placeholder="è«‹è¼¸å…¥é‡‘é¡">
                </div>

                <button class="btn" onclick="processDiagnosis()">é–‹å§‹è¨ºæ–· <i class="fas fa-paw" style="margin-left:5px;"></i></button>
            </div>

            <div id="result" class="hidden">
                
                <div id="animal-persona-area"></div>

                <div id="debt-overview-area"></div>

                <div id="budget-area"></div>

                <div id="prescription-area"></div>

                <button id="over50-btn" class="btn btn-warning" style="margin-top:20px;" onclick="showSurvivalPage()">ğŸ†˜ å›ºå®šæ”¯å‡º > ç¸½æ”¶å…¥ 50%ï¼Ÿé»æ­¤è™•</button>
                <button id="summary-report-btn" class="btn btn-info hidden" style="margin-top:10px;" onclick="showFullReport()">ğŸ“Š æŸ¥çœ‹è©³ç´°è²¡å‹™å ±å‘Š</button>
                
                <button class="btn-outline" style="margin-top:30px;" onclick="location.reload()">é‡æ–°æª¢æ¸¬</button>
            </div>
        </div>

        <div class="container hidden" id="page2">
            <h1>Fixed Cost Check</h1>
            <p style="color:var(--text-secondary); margin-bottom:20px;">å›ºå®šæ”¯å‡ºæ·±åº¦ç›¤é»</p>
            <div id="fixed-exp-list">
                <div class="debt-item"><div class="debt-grid"><div><div class="grid-label">é …ç›®</div><input type="text" class="f-name"></div><div><div class="grid-label">é‡‘é¡</div><input type="number" class="f-pay"></div></div></div>
            </div>
            <button class="btn-outline" onclick="addFixedExp()">ï¼‹ æ–°å¢é …ç›®</button>
            <div id="survival-result" class="diag-box" style="background:#fffaf0; display:none; margin-top:20px; border-left:4px solid var(--accent);"></div>
            <button class="btn" onclick="calcSurvival()">é‡æ–°ç²¾ç®—</button>
            <button class="btn-outline" style="margin-top:10px;" onclick="backToPage1()">è¿”å›</button>
        </div>

        <div class="container hidden" id="page3">
            <h1>Full Report</h1>
            <div id="full-report-content" class="full-report"></div>
            <button class="btn" style="margin-top:20px;" onclick="backToPage1FromReport()">è¿”å›</button>
        </div>
    </div>

    <script>
        let globalIncome = 0, userHasDebt = 'no', userHasFund = 'no', debtData = [];
        let selectedType = 'stable';
        let budgetChart = null;
        
        // ç”¢å“é€£çµ (å¦³å¯ä»¥éš¨æ™‚æ›¿æ›é€™è£¡)
        const LINK_BOOK = "https://myship.7-11.com.tw/general/detail/GM2502152714662"; // è¨˜å¸³æœ¬
        const LINK_BAG = "https://myship.7-11.com.tw/general/detail/GM2502152714662";  // å­˜éŒ¢è¢‹/éŒ¢æ¶ (æš«ç”¨è³£å ´é€£çµ)
        const LINK_NOTE = "https://myship.7-11.com.tw/general/detail/GM2502152714662"; // é›™æ‰£æ‰‹å¸³ (æš«ç”¨è³£å ´é€£çµ)
        const IG_VIDEO_URL = "https://www.instagram.com/reel/DTP7iSMgagR/";

        function toggleDebtSection() {
            const has = document.getElementById('hasDebt').value;
            document.getElementById('debt-input-group').style.display = (has === 'yes') ? 'block' : 'none';
            document.getElementById('emergency-fund-group').style.display = (has === 'no') ? 'block' : 'none';
        }
        
        function selectType(type) {
            selectedType = type;
            document.getElementById('type-stable').classList.remove('selected');
            document.getElementById('type-unstable').classList.remove('selected');
            document.getElementById('type-' + type).classList.add('selected');
        }

        function addDebt() {
            const div = document.createElement('div'); div.className = 'debt-item';
            div.innerHTML = `<div class="debt-grid"><div><div class="grid-label">é …ç›®åç¨±</div><input type="text" class="d-name"></div><div><div class="grid-label">å¹´åˆ©ç‡ %</div><input type="number" step="0.1" class="d-rate"></div><div><div class="grid-label">æ¯æœˆç¹³æ¬¾</div><input type="number" class="d-pay"></div><div><div class="grid-label">å‰©é¤˜æœŸæ•¸</div><input type="number" class="d-months"></div></div>`;
            document.getElementById('debt-list').appendChild(div);
        }
        function addFixedExp() {
            const div = document.createElement('div'); div.className = 'debt-item';
            div.innerHTML = `<div class="debt-grid"><div><div class="grid-label">æ”¯å‡ºé …ç›®</div><input type="text" class="f-name"></div><div><div class="grid-label">é‡‘é¡</div><input type="number" class="f-pay"></div></div>`;
            document.getElementById('fixed-exp-list').appendChild(div);
        }

        function processDiagnosis() {
            userHasDebt = document.getElementById('hasDebt').value;
            userHasFund = (userHasDebt === 'no') ? document.getElementById('hasEmergencyFund').value : 'no';
            globalIncome = parseFloat(document.getElementById('monthlyIncome').value) || 0;

            if (globalIncome <= 0) return alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„æœˆæ”¶å…¥é‡‘é¡å–”ï¼");

            document.getElementById('quiz-form').classList.add('hidden');
            document.getElementById('result').classList.remove('hidden');

            // 1. è™•ç†å‚µå‹™æ•¸æ“š
            debtData = [];
            let totalMonthlyDebtPay = 0, highDebts = [];
            if (userHasDebt === 'yes') {
                userHasFund = 'yes'; // æœ‰å‚µå‹™æˆ‘å€‘é è¨­ä»–å¯èƒ½æœ‰é å‚™é‡‘ç‹€æ…‹æ˜¯ Turtle (æˆ–é€éé‚è¼¯åˆ¤æ–·)
                // é€™è£¡ç°¡åŒ–é‚è¼¯ï¼šæœ‰å‚µå‹™çš„äººï¼Œå¦‚æœæœ‰å¡«å¯«è² å‚µï¼Œé€šå¸¸é å‚™é‡‘ä¸è¶³æˆ–æ­£åœ¨åŠªåŠ›
                // ä½†ç‚ºäº†å‹•ç‰©åˆ¤æ–·ï¼Œæˆ‘å€‘å‡è¨­æœ‰å‚µå‹™ = çƒé¾œ (èƒŒæ®¼å‰è¡Œ)
                
                const rates = document.getElementsByClassName('d-rate'), pays = document.getElementsByClassName('d-pay'), names = document.getElementsByClassName('d-name'), months = document.getElementsByClassName('d-months');
                for (let i = 0; i < rates.length; i++) {
                    let p = parseFloat(pays[i].value) || 0, r = parseFloat(rates[i].value) || 0, m = parseFloat(months[i].value) || 0, n = names[i].value || `é …ç›®${i+1}`;
                    totalMonthlyDebtPay += p;
                    let totalPay = p * m, estInterest = totalPay - (totalPay / (1 + (r * m / 2400)));
                    debtData.push({name: n, rate: r, pay: p, month: m, totalDebt: totalPay, savedInterest: estInterest});
                    if (r >= 5) highDebts.push(n);
                }
            }

            // 2. æ±ºå®šå‹•ç‰©äººæ ¼ & è™•æ–¹
            renderAnimalAndPrescription(userHasDebt, userHasFund, selectedType, highDebts);

            // 3. æ¸²æŸ“å‚µå‹™ç¸½è¦½ (è‹¥æœ‰)
            const overviewArea = document.getElementById('debt-overview-area');
            const overBtn = document.getElementById('over50-btn');
            const summaryBtn = document.getElementById('summary-report-btn');
            
            if (userHasDebt === 'yes') {
                let debtRatio = (totalMonthlyDebtPay / globalIncome) * 100;
                overviewArea.innerHTML = `<div class="debt-summary-card"><div class="summary-item"><span class="summary-label">æ¯æœˆé‚„å‚µç¸½é¡</span><span class="summary-value">$${totalMonthlyDebtPay.toLocaleString()}</span></div><div class="summary-item"><span class="summary-label">å‚µå‹™ä½”æ¯”</span><span class="summary-value">${debtRatio.toFixed(1)}%</span></div></div>`;
                summaryBtn.classList.remove('hidden');
                if (debtRatio > 50) overBtn.classList.add('hidden'); else overBtn.classList.remove('hidden');
            } else {
                overviewArea.innerHTML = "";
                summaryBtn.classList.add('hidden');
                overBtn.classList.remove('hidden');
            }

            // 4. æ¸²æŸ“é ç®—åœ–è¡¨ (é«˜åˆ©è²¸è€…ä½¿ç”¨ç‰¹æ®Šæ¯”ä¾‹)
            const isHighDebt = highDebts.length > 0;
            renderBudget(globalIncome, document.getElementById('budget-area'), userHasFund, (userHasDebt === 'yes'), !isHighDebt);
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function renderAnimalAndPrescription(hasDebt, hasFund, incomeType, highDebts) {
            let animal = {}, prescription = {};

            // --- é‚è¼¯åˆ¤æ–· ---
            if (hasDebt === 'yes') {
                // æœ‰å‚µå‹™ -> çƒé¾œ (å³ä½¿æœ‰é å‚™é‡‘ï¼Œå‚µå‹™ä»æ˜¯æ®¼)
                animal = {
                    emoji: 'ğŸ¢', title: 'ç©©å¥çš„çƒé¾œ', tag: 'æ…¢æ­¥å‰è¡Œ',
                    desc: 'é›–ç„¶èƒŒè‘—æ²‰é‡çš„æ®¼ï¼ˆå‚µå‹™ï¼‰ï¼Œä½†å¦³æœ‰ç›®æ¨™ã€æœ‰æ–¹å‘ã€‚åªè¦è…³æ­¥ä¸åœï¼Œçµ‚é»ä¸€å®šæœƒåˆ°ã€‚ç¾åœ¨çš„å¦³éœ€è¦çš„æ˜¯è€å¿ƒèˆ‡ç²¾æº–çš„é‚„æ¬¾ç­–ç•¥ã€‚'
                };
                if (highDebts.length > 0) {
                    prescription = {
                        title: 'é«˜åˆ©æ­¢è¡€æ–¹æ¡ˆ',
                        text: `åµæ¸¬åˆ°é«˜åˆ©ç‡å‚µå‹™ (${highDebts.join('ã€')})ï¼é€™æ˜¯åœ¨è®“å¦³æ¼è²¡çš„å…ƒå…‡ã€‚å¦³ç¾åœ¨æ€¥éœ€æ­¢è¡€ï¼Œè«‹å„ªå…ˆè™•ç†å®ƒã€‚`,
                        btnText: 'ğŸ“š å–å¾—åŸå‰µè¨˜å¸³æœ¬ (å‚µå‹™é›ªçƒæ³•)', link: LINK_BOOK
                    };
                } else {
                    prescription = {
                        title: 'å‚µå‹™æ•´ç†æ–¹æ¡ˆ',
                        text: 'å‚µå‹™ä¸å¯æ€•ï¼Œå¯æ€•çš„æ˜¯æ··äº‚ã€‚å»ºè­°ä½¿ç”¨å°ˆç”¨çš„å‚µå‹™é é¢ï¼ŒæŠŠæ¯ä¸€ç­†æ¬¾é …è¦–è¦ºåŒ–ï¼Œçœ‹è‘—æ•¸å­—æ¸›å°‘æœƒæ›´æœ‰å‹•åŠ›ï¼',
                        btnText: 'ğŸ“š å–å¾—åŸå‰µè¨˜å¸³æœ¬', link: LINK_BOOK
                    };
                }
            } else {
                // ç„¡å‚µå‹™
                if (hasFund === 'no') {
                    // ç„¡å‚µ + ç„¡é å‚™é‡‘ = å€‰é¼  (æœˆå…‰/åŸåœ°è·‘)
                    animal = {
                        emoji: 'ğŸ¹', title: 'å¿™ç¢Œçš„å€‰é¼ ', tag: 'æ»¾è¼ªå¾ªç’°',
                        desc: 'å¦³å¾ˆåŠªåŠ›ç”Ÿæ´»ï¼Œä½†å°±åƒåœ¨æ»¾è¼ªä¸Šå¥”è·‘ï¼Œè–ªæ°´é€²ä¾†åˆå‡ºå»ï¼Œå¥½åƒæ²’ç•™ä¸‹ä»€éº¼ã€‚å¦³éœ€è¦æŒ‰ä¸‹æš«åœéµï¼Œå¹«è‡ªå·±å­˜ä¸‹ç¬¬ä¸€ç­†åº•æ°£ã€‚'
                    };
                    prescription = {
                        title: 'å¼·åˆ¶å„²è“„æ–¹æ¡ˆ',
                        text: 'éŒ¢æ”¾åœ¨æˆ¶é ­æœƒå¿ä¸ä½èŠ±æ‰ï¼Ÿå¦³éœ€è¦ç‰©ç†éš”é›¢ï¼ä½¿ç”¨é›™æ‰£æ‰‹å¸³æŠŠã€Œé å‚™é‡‘ã€é–èµ·ä¾†ï¼Œé€™æ˜¯å°æœªä¾†çš„å¦³æœ€æº«æŸ”çš„ä¿è­·ã€‚',
                        btnText: 'ğŸ“’ Bear é›™æ‰£æ‰‹å¸³ (å¼·åˆ¶å„²è“„)', link: LINK_NOTE
                    };
                } else if (incomeType === 'unstable') {
                    // ç„¡å‚µ + æœ‰é å‚™é‡‘ + æ”¶å…¥ä¸ç©© = æ¾é¼ 
                    animal = {
                        emoji: 'ğŸ¿ï¸', title: 'æ©Ÿéˆçš„æ¾é¼ ', tag: 'å±¯ç³§é«˜æ‰‹',
                        desc: 'å› ç‚ºæ”¶å…¥èµ·ä¼ï¼Œå¦³æ¯”åˆ¥äººæ›´æ‡‚å¾—æœªé›¨ç¶¢ç¹†ã€‚å¦³çš„å¿«æ¨‚ä¾†è‡ªæ–¼çœ‹è‘—ã€Œè“„æ°´æ± ã€çš„æ°´ä½ä¸Šå‡ï¼Œé‚£è®“å¦³åœ¨å†¬å¤©ä¹Ÿèƒ½å®‰ç©©éå†¬ã€‚'
                    };
                    prescription = {
                        title: 'è¦–è¦ºåŒ–å®‰å…¨æ„Ÿæ–¹æ¡ˆ',
                        text: 'å°æ–¼æ”¶å…¥ä¸ç©©çš„å¦³ï¼Œã€Œçœ‹å¾—åˆ°ã€çš„éŒ¢æœ€å®‰å¿ƒã€‚å»ºç«‹å¯¦é«”è“„æ°´æ± ï¼Œè®“æ¯ä¸€åˆ†åŠªåŠ›éƒ½å…·è±¡åŒ–ã€‚',
                        btnText: 'ğŸ’° è³ªæ„Ÿå­˜éŒ¢è¢‹/éŒ¢æ¶ (å»ºç«‹è“„æ°´æ± )', link: LINK_BAG
                    };
                } else {
                    // ç„¡å‚µ + æœ‰é å‚™é‡‘ + ç©©å®š = ç…å­
                    animal = {
                        emoji: 'ğŸ¦', title: 'è‡ªä¿¡çš„ç…å­', tag: 'æŒæ§å…¨å ´',
                        desc: 'æ­å–œå¦³ï¼å¦³æ“æœ‰æ¥µä½³çš„è²¡å‹™åº•æ°£ã€‚å¦³ä¸æ˜¯åœ¨ç‚ºç”Ÿå­˜å¥”æ³¢ï¼Œè€Œæ˜¯åœ¨ç‚ºé¸æ“‡æ¬Šè€Œæ´»ã€‚å¦³æ˜¯æ£®æ—ä¹‹ç‹ï¼ŒæŒæ§è‘—è‡ªå·±çš„ç”Ÿæ´»ç¯€å¥ã€‚'
                    };
                    prescription = {
                        title: 'è²¡å¯Œå¢å€¼æ–¹æ¡ˆ',
                        text: 'å¦³çš„åŸºç¤å¾ˆç©©å›ºï¼Œç¾åœ¨å¯ä»¥å°ˆæ³¨æ–¼è®“è³‡ç”¢é•·å¤§ï¼Œæˆ–æ˜¯æŠ•è³‡è‡ªå·±ã€‚ä¿æŒè¨˜å¸³ç¿’æ…£ï¼Œåˆ¥è®“ç´°ç¯€å·èµ°å¦³çš„è²¡å¯Œã€‚',
                        btnText: 'ğŸ“š è³ªæ„Ÿæ›¸è¡£è¨˜å¸³æœ¬ (ç¶­æŒå¥½ç¿’æ…£)', link: LINK_BOOK
                    };
                }
            }

            // --- æ¸²æŸ“å‹•ç‰©å¡ç‰‡ ---
            document.getElementById('animal-persona-area').innerHTML = `
                <div class="animal-card">
                    <span class="animal-emoji">${animal.emoji}</span>
                    <span class="animal-tag">#${animal.tag}</span>
                    <div class="animal-title">${animal.title}</div>
                    <div class="animal-desc">${animal.desc}</div>
                </div>
            `;

            // --- æ¸²æŸ“è™•æ–¹ç±¤ ---
            document.getElementById('prescription-area').innerHTML = `
                <div class="prescription-container">
                    <div class="prescription-header"><i class="fas fa-file-medical"></i> Bear çš„è™•æ–¹ç±¤</div>
                    <div class="prescription-text">
                        <b>è¨ºæ–·ï¼š${prescription.title}</b><br>
                        ${prescription.text}
                    </div>
                    <a href="${prescription.link}" target="_blank" class="product-link-btn">${prescription.btnText} <i class="fas fa-arrow-right"></i></a>
                </div>
            `;
        }

        function renderBudget(income, container, hasFund, isDebtMode, isLowDebt) {
            let f, v, pre, e, s, i;
            if (isDebtMode && isLowDebt) { f=0.6; v=0.2; pre=0.1; e=0.05; s=0; i=0.05; }
            else if (hasFund === 'no') { f=0.5; v=0.2; pre=0.1; e=0.1; s=0.05; i=0.05; }
            else { f=0.5; v=0.2; pre=0.1; e=0; s=0.15; i=0.05; }
            
            const categories = [
                { label: 'å›ºå®šæ”¯å‡º', pct: f, color: '#5a4d41' },
                { label: 'è®Šå‹•æ”¯å‡º', pct: v, color: '#b08d85' },
                { label: 'é å­˜æ”¯å‡º', pct: pre, color: '#d4a373' },
                { label: 'ç·Šæ€¥é å‚™', pct: e, color: '#e57373' },
                { label: 'å„²è“„æŠ•è³‡', pct: s, color: '#81c784' },
                { label: 'æŠ•è³‡è‡ªå·±', pct: i, color: '#ffd54f' }
            ];

            let html = `<div class="budget-card"><div style="font-weight:600; font-size:1.1rem; margin-bottom:5px; color:var(--text-primary);">ğŸ’¡ ç†æƒ³é ç®—åˆ†é…</div><div class="chart-container"><canvas id="budgetChart"></canvas></div>`;
            let labels=[], data=[], colors=[];
            categories.forEach(cat => {
                if (cat.pct > 0) {
                    html += `<div class="budget-row"><span style="display:flex; align-items:center;"><span style="display:inline-block; width:10px; height:10px; background:${cat.color}; border-radius:50%; margin-right:8px;"></span>${cat.label} (${Math.round(cat.pct*100)}%)</span><b>$${Math.round(income*cat.pct).toLocaleString()}</b></div>`;
                    labels.push(cat.label); data.push(Math.round(income * cat.pct)); colors.push(cat.color);
                }
            });
            html += `</div>`;
            container.innerHTML = html;

            setTimeout(() => {
                const ctx = document.getElementById('budgetChart').getContext('2d');
                if (budgetChart) budgetChart.destroy();
                budgetChart = new Chart(ctx, { type: 'doughnut', data: { labels: labels, datasets: [{ data: data, backgroundColor: colors, borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } });
            }, 100);
        }

        function showSurvivalPage() { document.getElementById('page1').classList.add('hidden'); document.getElementById('page2').classList.remove('hidden'); }
        function backToPage1() { document.getElementById('page2').classList.add('hidden'); document.getElementById('page1').classList.remove('hidden'); }
        function showFullReport() { document.getElementById('page1').classList.add('hidden'); document.getElementById('page3').classList.remove('hidden'); const content = document.getElementById('full-report-content'); let totalMonthly = 0; debtData.forEach(d => totalMonthly += d.pay); let ratio = ((totalMonthly / globalIncome) * 100).toFixed(1); let html = `<div class="report-row"><span class="report-title">æ¯æœˆæ”¶å…¥</span><span>$${globalIncome.toLocaleString()}</span></div><div class="report-row"><span class="report-title">æ¯æœˆé‚„å‚µ</span><span style="color:var(--danger); font-weight:bold;">$${totalMonthly.toLocaleString()}</span></div><div class="report-row"><span class="report-title">å‚µå‹™ä½”æ¯”</span><span style="color:var(--danger); font-weight:bold;">${ratio}%</span></div><h4 style="margin:20px 0 10px 0; border-bottom:1px solid #eee; padding-bottom:5px;">ğŸ“Œ è² å‚µæ˜ç´°</h4><div class="debt-table-wrapper"><table class="debt-table"><tr><th>é …ç›®(åˆ©ç‡)</th><th>æœˆç¹³</th><th>æœŸæ•¸</th><th>ç¸½æ¬ æ¬¾</th><th>çœåˆ©æ¯</th></tr>`; debtData.forEach(d => { html += `<tr><td>${d.name}<br>(${d.rate}%)</td><td>$${d.pay.toLocaleString()}</td><td>${d.month}</td><td>$${Math.round(d.totalDebt).toLocaleString()}</td><td class="save-money">$${Math.round(d.savedInterest).toLocaleString()}</td></tr>`; }); html += `</table></div>`; content.innerHTML = html; }
        function backToPage1FromReport() { document.getElementById('page3').classList.add('hidden'); document.getElementById('page1').classList.remove('hidden'); }
        function addFixedExp() { const div = document.createElement('div'); div.className = 'debt-item'; div.innerHTML = `<div class="debt-grid"><div><div class="grid-label">é …ç›®</div><input type="text" class="f-name"></div><div><div class="grid-label">é‡‘é¡</div><input type="number" class="f-pay"></div></div>`; document.getElementById('fixed-exp-list').appendChild(div); }
        function calcSurvival() { const pays = document.getElementsByClassName('f-pay'); let total = 0; for(let p of pays) total += parseFloat(p.value)||0; const rem = globalIncome - total; const box = document.getElementById('survival-result'); box.style.display='block'; if(rem<0) box.innerHTML=`âš ï¸ <b>ç¼ºå£è­¦å ±ï¼š</b> $${Math.abs(rem).toLocaleString()}`; else box.innerHTML=`ğŸ“Œ <b>å¯åˆ†é…é¤˜é¡ï¼š</b> $${rem.toLocaleString()}`; }

        // ================= PWA Service Worker è¨»å†Š =================
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(registration => {
                        console.log('ServiceWorker è¨»å†ŠæˆåŠŸï¼Œç¯„åœ: ', registration.scope);
                    })
                    .catch(err => {
                        console.log('ServiceWorker è¨»å†Šå¤±æ•—: ', err);
                    });
            });
        }
    </script>
</body>
</html>
