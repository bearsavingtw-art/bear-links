<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bear è²¡å‹™é§•é§›è‰™ | Financial Cockpit</title>
    
    <link rel="manifest" href='data:application/manifest+json,%7B%22name%22%3A%22Bear%20%E8%B2%A1%E5%8B%99%E9%A7%95%E9%A7%9B%E8%89%99%22%2C%22short_name%22%3A%22Bear.saving%22%2C%22start_url%22%3A%22.%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%23fcfbf9%22%2C%22theme_color%22%3A%22%23fcfbf9%22%2C%22icons%22%3A%5B%7B%22src%22%3A%22logo.png%22%2C%22sizes%22%3A%22192x192%22%2C%22type%22%3A%22image%2Fpng%22%2C%22purpose%22%3A%22any%20maskable%22%7D%2C%7B%22src%22%3A%22logo.png%22%2C%22sizes%22%3A%22512x512%22%2C%22type%22%3A%22image%2Fpng%22%2C%22purpose%22%3A%22any%20maskable%22%7D%5D%7D'>

    <link rel="icon" type="image/png" sizes="192x192" href="logo.png">
    <link rel="icon" type="image/png" sizes="512x512" href="logo.png">
    <link rel="icon" href="logo.png" type="image/png">
    <link rel="apple-touch-icon" href="logo.png">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#fcfbf9">
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&family=Noto+Serif+TC:wght@400;600&family=Playfair+Display:wght@600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --bg-color: #fcfbf9;
            --text-primary: #5a4d41;
            --text-secondary: #968c83;
            --accent: #b08d85;
            --card-bg: #ffffff;
            --success: #81c784;
            --warning: #ffd54f;
            --danger: #e57373;
            --info: #64b5f6;
            --bar-bg: #eee;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: 'Montserrat', 'Noto Serif TC', sans-serif;
            background-color: var(--bg-color); color: var(--text-primary);
            margin: 0; padding: 0; padding-bottom: 90px;
            overscroll-behavior-y: none;
        }

        /* é ‚éƒ¨å°è¦½ */
        header {
            background: var(--bg-color); padding: 20px 20px 10px;
            text-align: center; position: sticky; top: 0; z-index: 10;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        h1 { font-family: 'Playfair Display', serif; margin: 0; color: var(--accent); font-size: 1.5rem; }

        /* é é¢åˆ‡æ› */
        .page { display: none; padding: 20px; animation: fadeIn 0.3s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* å¡ç‰‡é€šç”¨æ¨£å¼ */
        .card {
            background: var(--card-bg); border-radius: 15px; padding: 20px;
            box-shadow: 0 5px 15px rgba(90,77,65,0.05); margin-bottom: 20px;
            border: 1px solid rgba(176, 141, 133, 0.1);
        }
        .card-title { font-weight: 600; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }

        /* é ç®—é€²åº¦æ¢ */
        .budget-item { margin-bottom: 15px; }
        .budget-header { display: flex; justify-content: space-between; font-size: 0.9rem; margin-bottom: 5px; }
        .budget-bar-bg { width: 100%; height: 8px; background: var(--bar-bg); border-radius: 10px; overflow: hidden; }
        .budget-bar-fill { height: 100%; width: 0%; transition: 0.5s ease; border-radius: 10px; }
        .budget-remain { font-size: 0.8rem; color: var(--text-secondary); text-align: right; margin-top: 3px; }

        /* è³¼ç‰©å†·éœé–˜æ¨£å¼ */
        .logic-card { text-align: center; }
        .logic-btn-group { display: flex; gap: 15px; margin-top: 20px; }
        .btn-yes { background: var(--success); flex: 1; border:none; padding:15px; border-radius:10px; color:#fff; font-weight:600; }
        .btn-no { background: var(--danger); flex: 1; border:none; padding:15px; border-radius:10px; color:#fff; font-weight:600; }
        .result-icon { font-size: 3rem; margin-bottom: 10px; display: block; }
        
        /* è³¼ç‰©æ¸…å–®ç´€éŒ„æ¨£å¼ */
        .shop-list-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 0; border-bottom: 1px dashed #eee;
        }
        .shop-info { flex: 1; text-align: left; }
        .shop-name { font-weight: 600; font-size: 1rem; color: var(--text-primary); }
        .shop-meta { font-size: 0.8rem; color: var(--text-secondary); margin-top: 4px; }
        .shop-status { 
            padding: 5px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; 
            min-width: 60px; text-align: center; margin-left: 10px;
        }
        .status-pass { background: rgba(129, 199, 132, 0.2); color: var(--success); }
        .status-wait { background: rgba(255, 213, 79, 0.2); color: #f9a825; }
        .status-stop { background: rgba(229, 115, 115, 0.2); color: var(--danger); }
        
        .timer-badge {
            display: inline-block; background: #333; color: #fff; 
            padding: 3px 8px; border-radius: 4px; font-size: 0.7rem; margin-top: 5px;
            font-family: monospace;
        }

        /* å„€è¡¨æ¿æ•¸æ“šå¡ */
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .stat-box { background: var(--bg-color); padding: 15px; border-radius: 12px; text-align: center; }
        .stat-label { font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 5px; }
        .stat-value { font-size: 1.2rem; font-weight: 600; font-family: 'Montserrat', sans-serif; }
        .income { color: var(--text-primary); }
        .expense { color: var(--accent); }
        .balance { color: var(--success); }

        /* è¡¨å–®å…ƒä»¶ */
        .form-group { margin-bottom: 15px; }
        label { display: block; font-size: 0.9rem; margin-bottom: 5px; font-weight: 600; }
        input, select {
            width: 100%; padding: 12px; border: 1px solid #eee; border-radius: 10px;
            font-size: 1rem; background: var(--bg-color); outline: none; color: var(--text-primary);
            appearance: none; -webkit-appearance: none;
        }
        input:focus, select:focus { border-color: var(--accent); background: #fff; }

        .btn {
            width: 100%; padding: 15px; border: none; border-radius: 50px;
            background: var(--text-primary); color: #fff; font-weight: 600; font-size: 1rem;
            cursor: pointer; transition: 0.3s; margin-top: 10px;
            box-shadow: 0 4px 10px rgba(90,77,65,0.2); display: block; text-align: center; text-decoration: none;
        }
        .btn:active { transform: scale(0.98); }
        .btn-outline { background: transparent; border: 1px solid var(--accent); color: var(--accent); margin-top: 10px; box-shadow: none; }
        .btn-tool { background: #546e7a; margin-bottom: 20px; }
        .btn-cancel { background: #999; margin-top: 10px; }

        /* åˆ—è¡¨æ¨£å¼ */
        .tx-list { list-style: none; padding: 0; margin: 0; }
        .tx-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 0; border-bottom: 1px dashed #eee;
        }
        .tx-info { display: flex; flex-direction: column; }
        .tx-cat { font-weight: 600; font-size: 0.95rem; }
        .tx-amount { font-weight: 600; font-family: 'Montserrat', sans-serif; display: flex; flex-direction: column; align-items: flex-end; }
        .tx-method { font-size: 0.75rem; color: #999; margin-top: 2px; } /* [NEW] æ”¯ä»˜æ–¹å¼å°å­— */
        .amount-inc { color: var(--success); }
        .amount-exp { color: var(--accent); }
        .action-btns { display: flex; align-items: center; gap: 10px; margin-left: 10px;} /* å¾®èª¿é–“è· */
        .edit-btn { color: var(--info); cursor: pointer; padding: 5px; }
        .delete-btn { color: #ccc; cursor: pointer; padding: 5px; }

        /* åº•éƒ¨å°è¦½åˆ— */
        .bottom-nav {
            position: fixed; bottom: 0; width: 100%; background: #fff;
            display: flex; justify-content: space-around; padding: 12px 0 25px;
            border-top: 1px solid #eee; box-shadow: 0 -5px 15px rgba(0,0,0,0.03); z-index: 100;
        }
        .nav-item { text-align: center; color: var(--text-secondary); cursor: pointer; font-size: 0.8rem; flex: 1; }
        .nav-item i { display: block; font-size: 1.3rem; margin-bottom: 4px; }
        .nav-item.active { color: var(--accent); font-weight: 600; }

        .chart-wrapper { position: relative; height: 220px; width: 100%; display: flex; justify-content: center; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <header>
        <h1>Bear.saving</h1>
        <div style="font-size:0.8rem; color:var(--text-secondary);">Financial Cockpit v1.5</div>
    </header>

    <div id="page-dash" class="page active">
        <div class="stat-grid">
            <div class="stat-box">
                <div class="stat-label">æœ¬æœˆæ”¶å…¥</div>
                <div class="stat-value income" id="display-income">$0</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">æœ¬æœˆæ”¯å‡º</div>
                <div class="stat-value expense" id="display-expense">$0</div>
            </div>
        </div>
        
        <div class="btn btn-tool" onclick="switchPage('shop')" style="display:flex; justify-content:center; align-items:center; gap:10px;">
            <i class="fas fa-brain"></i> å•Ÿå‹•è³¼ç‰©å†·éœãƒ»é‚è¼¯é–˜
        </div>

        <div class="card">
            <div class="card-title">
                é ç®—å‰©é¤˜é¡åº¦
                <small style="font-weight:400; color:var(--accent); cursor:pointer;" onclick="switchPage('settings')">è¨­å®šé ç®— <i class="fas fa-cog"></i></small>
            </div>
            <div id="budget-container"></div>
        </div>

        <div class="card">
            <div class="card-title">æ”¯å‡ºçµæ§‹åˆ†æ</div>
            <div class="chart-wrapper">
                <canvas id="expenseChart"></canvas>
            </div>
        </div>
        
        <div class="card">
            <div class="card-title">æœ€è¿‘ 5 ç­†ç´€éŒ„</div>
            <ul class="tx-list" id="recent-tx-list"></ul>
        </div>

        <div class="card" style="text-align:center;">
            <div class="stat-label">æœ¬æœˆç¸½çµé¤˜ (åº•æ°£)</div>
            <div class="stat-value balance" id="display-balance" style="font-size:1.8rem;">$0</div>
        </div>
    </div>

    <div id="page-add" class="page">
        <div class="card">
            <div class="card-title" id="add-page-title">æ–°å¢ä¸€ç­†ç´€éŒ„</div>
            <div class="form-group">
                <label>æ—¥æœŸ</label>
                <input type="date" id="input-date">
            </div>
            <div class="form-group">
                <label>æ”¶æ”¯å¤§é¡</label>
                <select id="input-type" onchange="updateCategories()">
                    <option value="expense">æ”¯å‡º (Expense)</option>
                    <option value="income">æ”¶å…¥ (Income)</option>
                </select>
            </div>
            <div class="form-group">
                <label>è©³ç´°åˆ†é¡</label>
                <select id="input-category"></select>
            </div>
            
            <div class="form-group">
                <label>æ”¯ä»˜æ–¹å¼</label>
                <select id="input-method">
                    <option value="cash">ğŸ’µ ç¾é‡‘ (Cash)</option>
                    <option value="card">ğŸ’³ ä¿¡ç”¨å¡/è¡Œå‹•æ”¯ä»˜ (Card)</option>
                    <option value="other">ğŸ¦ è½‰å¸³/å…¶ä»– (Other)</option>
                </select>
            </div>

            <div class="form-group">
                <label>é‡‘é¡</label>
                <input type="number" id="input-amount" placeholder="0" inputmode="numeric">
            </div>
            <div class="form-group">
                <label>å‚™è¨» (é¸å¡«)</label>
                <input type="text" id="input-note" placeholder="ä¾‹å¦‚ï¼šåˆé¤ã€å…¨è¯...">
            </div>
            <button class="btn" id="save-btn" onclick="saveTransaction()">ç¢ºèªå„²å­˜ <i class="fas fa-check"></i></button>
            <button class="btn btn-cancel hidden" id="cancel-edit-btn" onclick="resetForm()">å–æ¶ˆä¿®æ”¹</button>
        </div>
    </div>

    <div id="page-shop" class="page">
        <div id="shop-step-1" class="card logic-card">
            <div style="font-size:3rem; margin-bottom:15px;">ğŸ›’</div>
            <h2 style="margin-bottom:10px;">è³¼ç‰©å†·éœé–˜</h2>
            <p style="color:var(--text-secondary); font-size:0.9rem; margin-bottom:20px;">å·¥ç¨‹å¸«é‚è¼¯ vs è³¼ç‰©è¡å‹•</p>
            
            <div class="form-group">
                <label>æƒ³è²·ä»€éº¼ï¼Ÿ</label>
                <input type="text" id="shop-name" placeholder="å•†å“åç¨±">
            </div>
            <div class="form-group">
                <label>åƒ¹æ ¼ ($)</label>
                <input type="number" id="shop-price" placeholder="åƒ¹æ ¼">
            </div>
            <div class="form-group">
                <label>å¦³çš„æœˆè–ª (è¨ˆç®—ç”Ÿå‘½åŒ¯ç‡)</label>
                <input type="number" id="shop-salary" placeholder="ä¾‹å¦‚ï¼š45000">
            </div>
            <button class="btn" onclick="startLogic()">é–‹å§‹è¨ºæ–· <i class="fas fa-arrow-right"></i></button>
            <button class="btn btn-outline" onclick="switchPage('dash')">è¿”å›å„€è¡¨æ¿</button>
        </div>

        <div id="shop-step-2" class="card logic-card hidden">
            <div id="q-icon" style="font-size:3rem; margin-bottom:10px;">ğŸ¤”</div>
            <h2 id="q-title" style="margin-bottom:10px; font-size:1.2rem;">Question</h2>
            <p id="q-desc" style="color:var(--text-secondary); margin-bottom:20px; min-height:60px;">Desc</p>
            <div id="q-data" style="margin-bottom:15px; font-weight:bold; color:var(--accent);"></div>
            <div class="logic-btn-group">
                <button class="btn-no" onclick="nextStep(false)" id="btn-no">No</button>
                <button class="btn-yes" onclick="nextStep(true)" id="btn-yes">Yes</button>
            </div>
        </div>

        <div id="shop-step-3" class="card logic-card hidden">
            <div id="logic-result-content"></div>
            <button class="btn" onclick="resetShop()">å†æ¸¬ä¸€æ¬¡</button>
            <button class="btn btn-outline" onclick="switchPage('shop')">æŸ¥çœ‹æ­·å²ç´€éŒ„</button>
        </div>

        <div id="shop-history-container" class="card">
            <div class="card-title">è³¼ç‰©é‚è¼¯ç´€éŒ„ (History)</div>
            <div id="shop-list-content"></div>
        </div>
    </div>

    <div id="page-settings" class="page">
        <div class="card">
            <div class="card-title">æœ¬æœˆé ç®—è¨­å®š (Budget)</div>
            <div class="form-group">
                <label>å›ºå®šæ”¯å‡ºé ç®—</label>
                <input type="number" id="budget-fixed" placeholder="0" onchange="saveBudget()">
            </div>
            <div class="form-group">
                <label>è®Šå‹•æ”¯å‡ºé ç®—</label>
                <input type="number" id="budget-var" placeholder="0" onchange="saveBudget()">
            </div>
            <div class="form-group">
                <label>é å­˜æ”¯å‡ºé ç®—</label>
                <input type="number" id="budget-save" placeholder="0" onchange="saveBudget()">
            </div>
            <p style="font-size:0.8rem; color:var(--text-secondary);">* è¼¸å…¥å¾Œè‡ªå‹•å„²å­˜</p>
        </div>

        <div class="card">
            <div class="card-title">æœ¬æœˆæ˜ç´°</div>
            <ul class="tx-list" id="full-tx-list"></ul>
        </div>

        <div class="card">
            <div class="card-title">è³‡æ–™å‚™ä»½</div>
            <button class="btn btn-outline" onclick="exportData()"><i class="fas fa-download"></i> ä¸‹è¼‰å‚™ä»½ (JSON)</button>
            <button class="btn btn-outline" onclick="document.getElementById('import-file').click()"><i class="fas fa-upload"></i> åŒ¯å…¥å‚™ä»½</button>
            <input type="file" id="import-file" style="display:none;" onchange="importData(this)">
            <button class="btn btn-outline" style="border-color:#e57373; color:#e57373;" onclick="clearData()"><i class="fas fa-trash"></i> æ¸…ç©ºè³‡æ–™</button>
        </div>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchPage('dash')" id="nav-dash">
            <i class="fas fa-chart-pie"></i> å„€è¡¨æ¿
        </div>
        <div class="nav-item" onclick="openAddPage()" id="nav-add">
            <i class="fas fa-plus-circle" style="font-size:1.5rem; color:var(--text-primary); transform:translateY(-2px);"></i> è¨˜å¸³
        </div>
        <div class="nav-item" onclick="switchPage('settings')" id="nav-settings">
            <i class="fas fa-sliders-h"></i> è¨­å®š/æ˜ç´°
        </div>
    </div>

    <script>
        // --- 1. è³‡æ–™èˆ‡åˆå§‹åŒ– ---
        const categories = {
            expense: ['å›ºå®šæ”¯å‡º', 'è®Šå‹•æ”¯å‡º', 'é å­˜æ”¯å‡º'],
            income: ['è–ªè³‡æ”¶å…¥', 'æ¥­å¤–æ”¶å…¥']
        };
        
        let transactions = JSON.parse(localStorage.getItem('bear_transactions')) || [];
        let budgets = JSON.parse(localStorage.getItem('bear_budgets')) || { 'å›ºå®šæ”¯å‡º': 0, 'è®Šå‹•æ”¯å‡º': 0, 'é å­˜æ”¯å‡º': 0 };
        let shoppingList = JSON.parse(localStorage.getItem('bear_shopping_list')) || [];
        
        let myChart = null;
        let editingId = null;

        let shopStep = 0;
        let shopScore = 0;
        let shopItem = {};
        const logicQuestions = [
            { id: 'need', icon: 'âš–ï¸', title: 'éœ€æ±‚é–˜', desc: 'æ˜¯å…¨æ–°çš„éœ€æ±‚ï¼Ÿé‚„æ˜¯å®¶è£¡æœ‰æ›¿ä»£å“ï¼Ÿ', yes: 'æ–°éœ€æ±‚ (+20)', no: 'æœ‰æ›¿ä»£å“ (-50)', val: (y)=>y?20:-50 },
            { id: 'cash', icon: 'ğŸ’°', title: 'è²¡åŠ›é–˜', desc: 'æ‰‹é‚Šæœ‰è¶³å¤ ç¾é‡‘å…¨é¡æ”¯ä»˜å—ï¼Ÿ', yes: 'æœ‰éŒ¢ (+20)', no: 'è¦åˆ†æœŸ (-100)', val: (y)=>y?20:-100 },
            { id: 'value', icon: 'â³', title: 'åƒ¹å€¼é–˜', desc: 'çœ‹ä¸Šæ–¹å·¥æ™‚ï¼Œå€¼å¾—ç”¨ç”Ÿå‘½å»æ›å—ï¼Ÿ', yes: 'å€¼å¾— (+10)', no: 'ä¸å€¼ (-30)', data: true, val: (y)=>y?10:-30 },
            { id: 'cool', icon: 'ğŸ”¥', title: 'å†·éœé–˜', desc: 'å¦‚æœæ²’æ‰“æŠ˜æˆ–ä¸èƒ½é¦¬ä¸Šæ‹¿åˆ°ï¼Œé‚„è²·å—ï¼Ÿ', yes: 'ç…§è²· (+30)', no: 'é‚£ç®—äº† (-30)', val: (y)=>y?30:-30 },
            { id: 'space', icon: 'ğŸ ', title: 'ç©ºé–“é–˜', desc: 'å®¶è£¡æœ‰ä½å­æ”¾å—ï¼Ÿ', yes: 'æœ‰ä½å­ (+10)', no: 'é‚„è¦å–¬ (-10)', val: (y)=>y?10:-10 }
        ];

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('input-date').valueAsDate = new Date();
            updateCategories();
            loadBudgetInputs();
            renderDashboard();
            setInterval(updateCountdowns, 1000);
        });

        // --- 2. é é¢åˆ‡æ› ---
        function switchPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('page-' + pageId).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            if (pageId === 'dash' || pageId === 'shop') document.getElementById('nav-dash').classList.add('active');
            else if (pageId === 'add') document.getElementById('nav-add').classList.add('active');
            else document.getElementById('nav-settings').classList.add('active');
            
            window.scrollTo(0, 0);
            if(pageId === 'dash') renderDashboard();
            if(pageId === 'settings') renderList();
            if(pageId === 'shop') {
                resetShop();
                renderShoppingList();
            }
        }

        function openAddPage() {
            resetForm();
            switchPage('add');
        }

        function resetForm() {
            editingId = null;
            document.getElementById('add-page-title').innerText = 'æ–°å¢ä¸€ç­†ç´€éŒ„';
            document.getElementById('save-btn').innerHTML = 'ç¢ºèªå„²å­˜ <i class="fas fa-check"></i>';
            document.getElementById('cancel-edit-btn').classList.add('hidden'); 
            document.getElementById('input-date').valueAsDate = new Date();
            document.getElementById('input-amount').value = '';
            document.getElementById('input-note').value = '';
            document.getElementById('input-method').value = 'cash'; // [NEW] é‡ç½®é è¨­ç‚ºç¾é‡‘
        }

        // --- 3. è¨˜å¸³æ ¸å¿ƒ ---
        function updateCategories() {
            const type = document.getElementById('input-type').value;
            const catSelect = document.getElementById('input-category');
            const currentVal = catSelect.value;
            catSelect.innerHTML = '';
            categories[type].forEach(cat => {
                let opt = document.createElement('option');
                opt.value = cat; opt.innerText = cat;
                catSelect.appendChild(opt);
            });
            if(currentVal) catSelect.value = currentVal;
        }

        function saveTransaction() {
            const date = document.getElementById('input-date').value;
            const type = document.getElementById('input-type').value;
            const category = document.getElementById('input-category').value;
            const amount = parseFloat(document.getElementById('input-amount').value);
            const note = document.getElementById('input-note').value;
            const method = document.getElementById('input-method').value; // [NEW] è®€å–æ”¯ä»˜æ–¹å¼

            if (!date || !amount) { alert('è«‹è¼¸å…¥å®Œæ•´è³‡è¨Šï¼'); return; }

            if (editingId) {
                const index = transactions.findIndex(t => t.id === editingId);
                if (index !== -1) {
                    // [NEW] æ›´æ–°æ™‚åŠ å…¥ method
                    transactions[index] = { id: editingId, date, type, category, amount, note, method };
                    alert('ä¿®æ”¹æˆåŠŸï¼âœï¸');
                }
            } else {
                // [NEW] æ–°å¢æ™‚åŠ å…¥ method
                transactions.unshift({ id: Date.now(), date, type, category, amount, note, method });
                alert('è¨˜å¸³æˆåŠŸï¼ğŸ’°');
            }
            localStorage.setItem('bear_transactions', JSON.stringify(transactions));
            resetForm();
            switchPage('dash');
        }

        function editTx(id) {
            const tx = transactions.find(t => t.id === id);
            if (!tx) return;
            editingId = id;
            document.getElementById('input-date').value = tx.date;
            document.getElementById('input-type').value = tx.type;
            updateCategories();
            document.getElementById('input-category').value = tx.category;
            document.getElementById('input-amount').value = tx.amount;
            document.getElementById('input-note').value = tx.note;
            // [NEW] å›å¡«æ”¯ä»˜æ–¹å¼ (è‹¥èˆŠè³‡æ–™æ²’æœ‰ methodï¼Œé è¨­ 'cash')
            document.getElementById('input-method').value = tx.method || 'cash';

            document.getElementById('add-page-title').innerText = 'ç·¨è¼¯ç´€éŒ„';
            document.getElementById('save-btn').innerHTML = 'ç¢ºèªä¿®æ”¹ <i class="fas fa-save"></i>';
            document.getElementById('cancel-edit-btn').classList.remove('hidden');
            switchPage('add');
        }

        function deleteTx(id) {
            if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) {
                transactions = transactions.filter(t => t.id !== id);
                localStorage.setItem('bear_transactions', JSON.stringify(transactions));
                renderDashboard(); renderList();
            }
        }

        // --- 4. é ç®—è¨­å®š ---
        function loadBudgetInputs() {
            document.getElementById('budget-fixed').value = budgets['å›ºå®šæ”¯å‡º'] || '';
            document.getElementById('budget-var').value = budgets['è®Šå‹•æ”¯å‡º'] || '';
            document.getElementById('budget-save').value = budgets['é å­˜æ”¯å‡º'] || '';
        }
        function saveBudget() {
            budgets['å›ºå®šæ”¯å‡º'] = parseFloat(document.getElementById('budget-fixed').value) || 0;
            budgets['è®Šå‹•æ”¯å‡º'] = parseFloat(document.getElementById('budget-var').value) || 0;
            budgets['é å­˜æ”¯å‡º'] = parseFloat(document.getElementById('budget-save').value) || 0;
            localStorage.setItem('bear_budgets', JSON.stringify(budgets));
        }

        // --- 5. å„€è¡¨æ¿èˆ‡åœ–è¡¨ ---
        function renderDashboard() {
            const currentMonth = new Date().toISOString().slice(0, 7);
            const monthTx = transactions.filter(t => t.date.startsWith(currentMonth));
            let totalInc = 0, totalExp = 0;
            let catExp = { 'å›ºå®šæ”¯å‡º': 0, 'è®Šå‹•æ”¯å‡º': 0, 'é å­˜æ”¯å‡º': 0 };

            monthTx.forEach(t => {
                if (t.type === 'income') totalInc += t.amount;
                else {
                    totalExp += t.amount;
                    if (catExp[t.category] !== undefined) catExp[t.category] += t.amount;
                }
            });
            document.getElementById('display-income').innerText = `$${totalInc.toLocaleString()}`;
            document.getElementById('display-expense').innerText = `$${totalExp.toLocaleString()}`;
            document.getElementById('display-balance').innerText = `$${(totalInc - totalExp).toLocaleString()}`;
            renderBudgetBars(catExp);
            renderChart(catExp);
            renderList(true);
        }

        function renderBudgetBars(currentExp) {
            const container = document.getElementById('budget-container');
            container.innerHTML = '';
            ['å›ºå®šæ”¯å‡º', 'è®Šå‹•æ”¯å‡º', 'é å­˜æ”¯å‡º'].forEach(cat => {
                const budget = budgets[cat] || 0;
                const spent = currentExp[cat] || 0;
                let percent = 0, colorVar = '--success';
                if (budget > 0) {
                    percent = (spent / budget) * 100;
                    if (percent > 100) colorVar = '--danger';
                    else if (percent > 80) colorVar = '--warning';
                }
                const remaining = budget - spent;
                const width = Math.min(percent, 100);
                container.innerHTML += `<div class="budget-item"><div class="budget-header"><span>${cat}</span><span>$${spent.toLocaleString()} / $${budget.toLocaleString()}</span></div><div class="budget-bar-bg"><div class="budget-bar-fill" style="width:${width}%; background:var(${colorVar});"></div></div><div class="budget-remain">å‰©é¤˜: <span style="color:var(${remaining < 0 ? '--danger' : '--text-primary'})">$${remaining.toLocaleString()}</span></div></div>`;
            });
            if (Object.values(budgets).every(b => b === 0)) container.innerHTML = '<div style="text-align:center; padding:10px; color:#ccc; font-size:0.8rem;">å°šæœªè¨­å®šé ç®—ï¼Œè«‹è‡³è¨­å®šé é¢è¼¸å…¥ã€‚</div>';
        }

        function renderChart(dataObj) {
            const ctx = document.getElementById('expenseChart').getContext('2d');
            const hasData = Object.values(dataObj).some(val => val > 0);
            if (myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['å›ºå®šæ”¯å‡º', 'è®Šå‹•æ”¯å‡º', 'é å­˜æ”¯å‡º'],
                    datasets: [{
                        data: hasData ? [dataObj['å›ºå®šæ”¯å‡º'], dataObj['è®Šå‹•æ”¯å‡º'], dataObj['é å­˜æ”¯å‡º']] : [1],
                        backgroundColor: hasData ? ['#5a4d41', '#b08d85', '#d4a373'] : ['#eee'],
                        borderWidth: 0
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { position: 'bottom' } } }
            });
        }

        // [NEW] æ•´åˆæ”¯ä»˜æ–¹å¼åœ–ç¤º
        function getMethodIcon(method) {
            if (method === 'card') return 'ğŸ’³';
            if (method === 'other') return 'ğŸ¦';
            return 'ğŸ’µ'; // é è¨­ç¾é‡‘
        }

        function renderList(isShort = false) {
            const listId = isShort ? 'recent-tx-list' : 'full-tx-list';
            const list = document.getElementById(listId);
            if (!list) return;
            list.innerHTML = '';
            const dataToShow = isShort ? transactions.slice(0, 5) : transactions;
            dataToShow.forEach(t => {
                const color = t.type === 'income' ? 'amount-inc' : 'amount-exp';
                const sign = t.type === 'income' ? '+' : '-';
                const methodIcon = getMethodIcon(t.method); // [NEW] å–å¾—åœ–ç¤º
                
                list.innerHTML += `
                    <li class="tx-item">
                        <div class="tx-info">
                            <span class="tx-cat">${t.category} <small style="color:#888;">${t.note}</small></span>
                            <span class="tx-date">${t.date} <span style="font-size:0.8rem; margin-left:5px;">${methodIcon}</span></span>
                        </div>
                        <div class="action-btns">
                            <span class="tx-amount ${color}">${sign}$${t.amount.toLocaleString()}</span>
                            <i class="fas fa-edit edit-btn" onclick="editTx(${t.id})"></i>
                            <i class="fas fa-trash delete-btn" onclick="deleteTx(${t.id})"></i>
                        </div>
                    </li>`;
            });
        }

        // --- 6. è³¼ç‰©å†·éœé–˜ ---
        function startLogic() {
            const name = document.getElementById('shop-name').value;
            const price = parseFloat(document.getElementById('shop-price').value);
            const salary = parseFloat(document.getElementById('shop-salary').value);
            if(!name || !price || !salary) { alert('è«‹è¼¸å…¥å®Œæ•´è³‡è¨Šï¼'); return; }
            
            shopItem = { name, price, wage: Math.round(salary/160), costHour: (price/(salary/160)).toFixed(1) };
            shopStep = 0; shopScore = 0;
            document.getElementById('shop-step-1').classList.add('hidden');
            document.getElementById('shop-step-2').classList.remove('hidden');
            document.getElementById('shop-history-container').classList.add('hidden'); 
            showQuestion();
        }

        function showQuestion() {
            const q = logicQuestions[shopStep];
            document.getElementById('q-icon').innerText = q.icon;
            document.getElementById('q-title').innerText = q.title;
            document.getElementById('q-desc').innerText = q.desc;
            document.getElementById('btn-yes').innerText = q.yes;
            document.getElementById('btn-no').innerText = q.no;
            if(q.data) document.getElementById('q-data').innerText = `éœ€èŠ±è²»å·¥æ™‚ï¼š${shopItem.costHour} å°æ™‚`;
            else document.getElementById('q-data').innerText = '';
        }

        function nextStep(isYes) {
            shopScore += logicQuestions[shopStep].val(isYes);
            shopStep++;
            if(shopStep < logicQuestions.length) showQuestion();
            else showShopResult();
        }

        function showShopResult() {
            document.getElementById('shop-step-2').classList.add('hidden');
            document.getElementById('shop-step-3').classList.remove('hidden');
            
            let html = '';
            let resultType = '';
            
            if(shopScore >= 60) {
                resultType = 'pass';
                html = `<span class="result-icon">ğŸŸ¢</span><h3>é€šé (PASS)</h3><p>ç†æ€§æŠ•è³‡ï¼ç¬¦åˆéœ€æ±‚èˆ‡åƒ¹å€¼ã€‚</p>`;
            } else if(shopScore >= 0) {
                resultType = 'wait';
                html = `<span class="result-icon">ğŸŸ¡</span><h3>å†·éœ (WAIT)</h3><p>å»ºè­°å•Ÿå‹• 72 å°æ™‚å†·éœæœŸã€‚</p>`;
            } else {
                resultType = 'stop';
                html = `<span class="result-icon">ğŸ”´</span><h3>é§å› (STOP)</h3><p>è¡å‹•æ¶ˆè²»ï¼æŠŠéŒ¢å­˜ä¸‹ä¾†å§ã€‚</p>`;
            }
            document.getElementById('logic-result-content').innerHTML = html;
            saveShoppingItem(resultType);
        }

        function saveShoppingItem(resultType) {
            const newItem = {
                id: Date.now(),
                name: shopItem.name,
                price: shopItem.price,
                costHour: shopItem.costHour,
                result: resultType,
                timestamp: Date.now()
            };
            shoppingList.unshift(newItem);
            localStorage.setItem('bear_shopping_list', JSON.stringify(shoppingList));
        }

        function resetShop() {
            document.getElementById('shop-step-3').classList.add('hidden');
            document.getElementById('shop-step-1').classList.remove('hidden');
            document.getElementById('shop-history-container').classList.remove('hidden'); 
            document.getElementById('shop-name').value = '';
            document.getElementById('shop-price').value = '';
            renderShoppingList();
        }

        function renderShoppingList() {
            const listContainer = document.getElementById('shop-list-content');
            if(!listContainer) return;
            
            if(shoppingList.length === 0) {
                listContainer.innerHTML = '<div style="text-align:center; padding:15px; color:#999; font-size:0.9rem;">ç›®å‰æ²’æœ‰è³¼ç‰©è©•ä¼°ç´€éŒ„</div>';
                return;
            }

            listContainer.innerHTML = '';
            shoppingList.forEach(item => {
                let badgeClass = '';
                let badgeText = '';
                let timerHtml = '';

                if (item.result === 'pass') {
                    badgeClass = 'status-pass'; badgeText = 'é€šé âœ…';
                } else if (item.result === 'wait') {
                    badgeClass = 'status-wait'; badgeText = 'å†·éœ â³';
                    timerHtml = `<div class="timer-badge" data-ts="${item.timestamp}">è¨ˆç®—ä¸­...</div>`;
                } else {
                    badgeClass = 'status-stop'; badgeText = 'é§å› ğŸ›‘';
                }

                listContainer.innerHTML += `
                    <div class="shop-list-item">
                        <div class="shop-info">
                            <div class="shop-name">${item.name} <span style="font-size:0.8rem; font-weight:400;">$${item.price.toLocaleString()}</span></div>
                            <div class="shop-meta">å·¥æ™‚: ${item.costHour}hr ${timerHtml}</div>
                        </div>
                        <div style="display:flex; align-items:center;">
                            <span class="shop-status ${badgeClass}">${badgeText}</span>
                            <i class="fas fa-trash delete-btn" style="margin-left:15px;" onclick="deleteShopItem(${item.id})"></i>
                        </div>
                    </div>
                `;
            });
            updateCountdowns();
        }

        function deleteShopItem(id) {
            if(confirm('ç¢ºå®šåˆªé™¤é€™ç­†ç´€éŒ„ï¼Ÿ')) {
                shoppingList = shoppingList.filter(i => i.id !== id);
                localStorage.setItem('bear_shopping_list', JSON.stringify(shoppingList));
                renderShoppingList();
            }
        }

        function updateCountdowns() {
            const timers = document.querySelectorAll('.timer-badge');
            const now = Date.now();
            timers.forEach(timer => {
                const createdTime = parseInt(timer.getAttribute('data-ts'));
                const endTime = createdTime + (72 * 60 * 60 * 1000);
                const diff = endTime - now;
                if (diff <= 0) {
                    timer.innerText = "å†·éœæœŸçµæŸ";
                    timer.style.background = "#888";
                } else {
                    const h = Math.floor(diff / (1000 * 60 * 60));
                    const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                    const s = Math.floor((diff % (1000 * 60)) / 1000);
                    timer.innerText = `${h}h ${m}m ${s}s`;
                }
            });
        }

        function exportData() {
            const data = { tx: transactions, budget: budgets, shop: shoppingList };
            const blob = new Blob([JSON.stringify(data)], {type: "text/json"});
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "bear_backup_" + new Date().toISOString().slice(0,10) + ".json";
            link.click();
        }

        function importData(input) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (Array.isArray(data)) { transactions = data; } 
                    else { 
                        transactions = data.tx || []; 
                        budgets = data.budget || {}; 
                        shoppingList = data.shop || []; 
                    }
                    localStorage.setItem('bear_transactions', JSON.stringify(transactions));
                    localStorage.setItem('bear_budgets', JSON.stringify(budgets));
                    localStorage.setItem('bear_shopping_list', JSON.stringify(shoppingList));
                    alert('åŒ¯å…¥æˆåŠŸï¼'); location.reload();
                } catch(err) { alert('æª”æ¡ˆéŒ¯èª¤'); }
            };
            reader.readAsText(input.files[0]);
        }

        function clearData() {
            if(confirm('ç¢ºå®šæ¸…ç©ºï¼Ÿ')) {
                localStorage.clear(); location.reload();
            }
        }
    </script>
</body>
</html>
