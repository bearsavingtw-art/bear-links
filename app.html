<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bear è²¡å‹™é§•é§›è‰™ | Financial Cockpit</title>
    
    <link rel="icon" href="logo.png" type="image/png">
    <link rel="apple-touch-icon" href="logo.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Bearè¨˜å¸³">
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&family=Noto+Serif+TC:wght@400;600&family=Playfair+Display:wght@600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --bg-color: #fcfbf9;
            --text-primary: #5a4d41;
            --text-secondary: #968c83;
            --accent: #b08d85;
            --card-bg: #ffffff;
            --success: #81c784;
            --danger: #e57373;
            --warning: #ffd54f;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: 'Montserrat', 'Noto Serif TC', sans-serif;
            background-color: var(--bg-color); color: var(--text-primary);
            margin: 0; padding: 0; padding-bottom: 90px; /* é¿é–‹åº•éƒ¨å°è¦½ */
            overscroll-behavior-y: none; /* é˜²æ­¢åœ¨é‚£é‚Šå½ˆä¾†å½ˆå» */
        }

        /* é ‚éƒ¨å°è¦½ */
        header {
            background: var(--bg-color); padding: 20px 20px 10px;
            text-align: center; position: sticky; top: 0; z-index: 10;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        h1 { font-family: 'Playfair Display', serif; margin: 0; color: var(--accent); font-size: 1.5rem; }

        /* é é¢åˆ‡æ›å®¹å™¨ */
        .page { display: none; padding: 20px; animation: fadeIn 0.3s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* å¡ç‰‡æ¨£å¼ */
        .card {
            background: var(--card-bg); border-radius: 15px; padding: 20px;
            box-shadow: 0 5px 15px rgba(90,77,65,0.05); margin-bottom: 20px;
            border: 1px solid rgba(176, 141, 133, 0.1);
        }
        .card-title { font-weight: 600; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }

        /* å„€è¡¨æ¿æ•¸æ“šå¡ */
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .stat-box { background: var(--bg-color); padding: 15px; border-radius: 12px; text-align: center; }
        .stat-label { font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 5px; }
        .stat-value { font-size: 1.2rem; font-weight: 600; font-family: 'Montserrat', sans-serif; }
        .income { color: var(--text-primary); }
        .expense { color: var(--accent); }
        .balance { color: var(--success); }

        /* è¼¸å…¥è¡¨å–® */
        .form-group { margin-bottom: 15px; }
        label { display: block; font-size: 0.9rem; margin-bottom: 5px; font-weight: 600; }
        input, select {
            width: 100%; padding: 12px; border: 1px solid #eee; border-radius: 10px;
            font-size: 1rem; background: var(--bg-color); outline: none; color: var(--text-primary);
            appearance: none; -webkit-appearance: none; /* iOS æ¨£å¼ä¿®æ­£ */
        }
        input:focus, select:focus { border-color: var(--accent); background: #fff; }

        .btn {
            width: 100%; padding: 15px; border: none; border-radius: 50px;
            background: var(--text-primary); color: #fff; font-weight: 600; font-size: 1rem;
            cursor: pointer; transition: 0.3s; margin-top: 10px;
            box-shadow: 0 4px 10px rgba(90,77,65,0.2);
        }
        .btn:active { transform: scale(0.98); }
        .btn-outline { background: transparent; border: 1px solid var(--accent); color: var(--accent); margin-top: 10px; box-shadow: none; }

        /* äº¤æ˜“åˆ—è¡¨ */
        .tx-list { list-style: none; padding: 0; margin: 0; }
        .tx-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 0; border-bottom: 1px dashed #eee;
        }
        .tx-info { display: flex; flex-direction: column; }
        .tx-cat { font-weight: 600; font-size: 0.95rem; }
        .tx-date { font-size: 0.75rem; color: #ccc; }
        .tx-amount { font-weight: 600; font-family: 'Montserrat', sans-serif; }
        .amount-inc { color: var(--success); }
        .amount-exp { color: var(--accent); }
        .delete-btn { color: #ccc; margin-left: 15px; cursor: pointer; padding: 5px; }

        /* åº•éƒ¨å°è¦½åˆ— (App é¢¨æ ¼) */
        .bottom-nav {
            position: fixed; bottom: 0; width: 100%; background: #fff;
            display: flex; justify-content: space-around; padding: 12px 0 25px; /* å¢åŠ åº•éƒ¨ç©ºé–“é©æ‡‰ iPhone Home Bar */
            border-top: 1px solid #eee; box-shadow: 0 -5px 15px rgba(0,0,0,0.03);
            z-index: 100;
        }
        .nav-item {
            text-align: center; color: var(--text-secondary); cursor: pointer; font-size: 0.8rem;
            flex: 1;
        }
        .nav-item i { display: block; font-size: 1.3rem; margin-bottom: 4px; }
        .nav-item.active { color: var(--accent); font-weight: 600; }

        /* Chart Container */
        .chart-wrapper { position: relative; height: 220px; width: 100%; display: flex; justify-content: center; }

    </style>
</head>
<body>

    <header>
        <h1>Bear.saving</h1>
        <div style="font-size:0.8rem; color:var(--text-secondary);">Financial Cockpit v1.0</div>
    </header>

    <div id="page-dash" class="page active">
        <div class="stat-grid">
            <div class="stat-box">
                <div class="stat-label">æœ¬æœˆæ”¶å…¥</div>
                <div class="stat-value income" id="display-income">$0</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">æœ¬æœˆæ”¯å‡º</div>
                <div class="stat-value expense" id="display-expense">$0</div>
            </div>
        </div>
        <div class="card" style="text-align:center; padding:15px;">
            <div class="stat-label">æœ¬æœˆçµé¤˜ (åº•æ°£)</div>
            <div class="stat-value balance" id="display-balance" style="font-size:1.8rem;">$0</div>
        </div>

        <div class="card">
            <div class="card-title">æ”¯å‡ºçµæ§‹åˆ†æ (è‰¯ç‡ç›£æ§)</div>
            <div class="chart-wrapper">
                <canvas id="expenseChart"></canvas>
            </div>
        </div>

        <div class="card">
            <div class="card-title">
                æœ€è¿‘ 5 ç­†ç´€éŒ„
                <small style="font-weight:400; color:var(--accent); cursor:pointer;" onclick="switchPage('list')">æŸ¥çœ‹å…¨éƒ¨</small>
            </div>
            <ul class="tx-list" id="recent-tx-list">
                </ul>
        </div>
    </div>

    <div id="page-add" class="page">
        <div class="card">
            <div class="card-title">æ–°å¢ä¸€ç­†ç´€éŒ„</div>
            
            <div class="form-group">
                <label>æ—¥æœŸ</label>
                <input type="date" id="input-date">
            </div>

            <div class="form-group">
                <label>æ”¶æ”¯å¤§é¡</label>
                <select id="input-type" onchange="updateCategories()">
                    <option value="expense">æ”¯å‡º (Expense)</option>
                    <option value="income">æ”¶å…¥ (Income)</option>
                </select>
            </div>

            <div class="form-group">
                <label>è©³ç´°åˆ†é¡</label>
                <select id="input-category">
                    </select>
            </div>

            <div class="form-group">
                <label>é‡‘é¡</label>
                <input type="number" id="input-amount" placeholder="0" inputmode="numeric">
            </div>

            <div class="form-group">
                <label>å‚™è¨» (é¸å¡«)</label>
                <input type="text" id="input-note" placeholder="ä¾‹å¦‚ï¼šåˆé¤ã€å…¨è¯...">
            </div>

            <button class="btn" onclick="addTransaction()">ç¢ºèªå„²å­˜ <i class="fas fa-check"></i></button>
        </div>
    </div>

    <div id="page-list" class="page">
        <div class="card">
            <div class="card-title">æœ¬æœˆæ˜ç´°</div>
            <ul class="tx-list" id="full-tx-list"></ul>
        </div>

        <div class="card">
            <div class="card-title">è³‡æ–™ç®¡ç† (Data Mgmt)</div>
            <p style="font-size:0.8rem; color:#888; line-height:1.6;">
                <i class="fas fa-shield-alt"></i> è³‡æ–™åƒ…å„²å­˜æ–¼æ‚¨çš„ç€è¦½å™¨ä¸­ï¼Œ100% éš±ç§å®‰å…¨ã€‚<br>
                <i class="fas fa-exclamation-triangle" style="color:#e57373;"></i> æ›æ‰‹æ©Ÿæˆ–æ¸…é™¤ç€è¦½å™¨å‰ï¼Œè«‹å‹™å¿…é»æ“Šã€Œä¸‹è¼‰å‚™ä»½ã€ã€‚
            </p>
            <button class="btn btn-outline" onclick="exportData()"><i class="fas fa-download"></i> ä¸‹è¼‰å‚™ä»½ (JSON)</button>
            <button class="btn btn-outline" onclick="document.getElementById('import-file').click()"><i class="fas fa-upload"></i> åŒ¯å…¥å‚™ä»½</button>
            <input type="file" id="import-file" style="display:none;" onchange="importData(this)">
            <button class="btn btn-outline" style="border-color:#e57373; color:#e57373;" onclick="clearData()"><i class="fas fa-trash"></i> æ¸…ç©ºæ‰€æœ‰è³‡æ–™</button>
        </div>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchPage('dash')" id="nav-dash">
            <i class="fas fa-chart-pie"></i> å„€è¡¨æ¿
        </div>
        <div class="nav-item" onclick="switchPage('add')" id="nav-add">
            <i class="fas fa-plus-circle" style="font-size:1.5rem; color:var(--text-primary); transform:translateY(-2px);"></i> è¨˜å¸³
        </div>
        <div class="nav-item" onclick="switchPage('list')" id="nav-list">
            <i class="fas fa-list"></i> æ˜ç´°/è¨­å®š
        </div>
    </div>

    <script>
        // --- 1. åˆå§‹åŒ–è³‡æ–™èˆ‡è¨­å®š ---
        const categories = {
            expense: ['å›ºå®šæ”¯å‡º', 'è®Šå‹•æ”¯å‡º', 'é å­˜æ”¯å‡º'],
            income: ['è–ªè³‡æ”¶å…¥', 'æ¥­å¤–æ”¶å…¥']
        };
        
        // å¾ LocalStorage è®€å–è³‡æ–™ï¼Œå¦‚æœæ²’æœ‰å‰‡ç‚ºç©ºé™£åˆ—
        let transactions = JSON.parse(localStorage.getItem('bear_transactions')) || [];
        let myChart = null;

        // åˆå§‹åŒ–åŸ·è¡Œ
        document.addEventListener('DOMContentLoaded', () => {
            // è¨­å®šæ—¥æœŸé è¨­ç‚ºä»Šå¤©
            document.getElementById('input-date').valueAsDate = new Date();
            updateCategories();
            renderDashboard();
        });

        // --- 2. æ ¸å¿ƒé‚è¼¯ ---

        function switchPage(pageId) {
            // åˆ‡æ›é é¢é¡¯ç¤º
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('page-' + pageId).classList.add('active');
            
            // åˆ‡æ›å°è¦½åˆ—ç‹€æ…‹
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('nav-' + pageId).classList.add('active');
            
            // é é¢æ»¾å‹•å›é ‚éƒ¨
            window.scrollTo(0, 0);

            if(pageId === 'dash') renderDashboard();
            if(pageId === 'list') renderList();
        }

        function updateCategories() {
            const type = document.getElementById('input-type').value;
            const catSelect = document.getElementById('input-category');
            catSelect.innerHTML = '';
            categories[type].forEach(cat => {
                let opt = document.createElement('option');
                opt.value = cat;
                opt.innerText = cat;
                catSelect.appendChild(opt);
            });
        }

        function addTransaction() {
            const date = document.getElementById('input-date').value;
            const type = document.getElementById('input-type').value;
            const category = document.getElementById('input-category').value;
            const amount = parseFloat(document.getElementById('input-amount').value);
            const note = document.getElementById('input-note').value;

            if (!date || !amount) {
                alert('è«‹è¼¸å…¥æ—¥æœŸèˆ‡é‡‘é¡ï¼(é€™æ˜¯ SOP å–”)');
                return;
            }

            const tx = {
                id: Date.now(), // ç”¨æ™‚é–“æˆ³è¨˜ç•¶ ID
                date, type, category, amount, note
            };

            transactions.unshift(tx); // åŠ åˆ°æœ€å‰é¢
            saveData();
            
            // é‡ç½®è¡¨å–®
            document.getElementById('input-amount').value = '';
            document.getElementById('input-note').value = '';
            alert('è¨˜å¸³æˆåŠŸï¼ğŸ’°');
            switchPage('dash');
        }

        function deleteTx(id) {
            if(confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿ')) {
                transactions = transactions.filter(t => t.id !== id);
                saveData();
                renderDashboard();
                renderList(); 
            }
        }

        function saveData() {
            localStorage.setItem('bear_transactions', JSON.stringify(transactions));
        }

        // --- 3. æ¸²æŸ“ç•«é¢ (Render) ---

        function renderDashboard() {
            // ç¯©é¸æœ¬æœˆè³‡æ–™
            const today = new Date();
            const currentMonth = today.toISOString().slice(0, 7); // "2026-02"
            
            const monthTx = transactions.filter(t => t.date.startsWith(currentMonth));
            
            // è¨ˆç®—ç¸½é¡
            let totalIncome = 0;
            let totalExpense = 0;
            let catExpense = { 'å›ºå®šæ”¯å‡º': 0, 'è®Šå‹•æ”¯å‡º': 0, 'é å­˜æ”¯å‡º': 0 };

            monthTx.forEach(t => {
                if (t.type === 'income') {
                    totalIncome += t.amount;
                } else {
                    totalExpense += t.amount;
                    if (catExpense[t.category] !== undefined) {
                        catExpense[t.category] += t.amount;
                    }
                }
            });

            // æ›´æ–° DOM
            document.getElementById('display-income').innerText = `$${totalIncome.toLocaleString()}`;
            document.getElementById('display-expense').innerText = `$${totalExpense.toLocaleString()}`;
            document.getElementById('display-balance').innerText = `$${(totalIncome - totalExpense).toLocaleString()}`;

            // æ›´æ–°æœ€è¿‘äº¤æ˜“åˆ—è¡¨
            const recentList = document.getElementById('recent-tx-list');
            recentList.innerHTML = '';
            transactions.slice(0, 5).forEach(t => {
                recentList.innerHTML += createTxHTML(t);
            });

            // æ›´æ–°åœ–è¡¨
            renderChart(catExpense);
        }

        function renderList() {
            const fullList = document.getElementById('full-tx-list');
            fullList.innerHTML = '';
            transactions.forEach(t => {
                fullList.innerHTML += createTxHTML(t);
            });
        }

        function createTxHTML(t) {
            const colorClass = t.type === 'income' ? 'amount-inc' : 'amount-exp';
            const sign = t.type === 'income' ? '+' : '-';
            return `
                <li class="tx-item">
                    <div class="tx-info">
                        <span class="tx-cat">${t.category} <small style="color:#888; font-weight:400;">${t.note}</small></span>
                        <span class="tx-date">${t.date}</span>
                    </div>
                    <div>
                        <span class="tx-amount ${colorClass}">${sign}$${t.amount.toLocaleString()}</span>
                        <i class="fas fa-trash delete-btn" onclick="deleteTx(${t.id})"></i>
                    </div>
                </li>
            `;
        }

        // --- 4. åœ–è¡¨ç¹ªè£½ ---
        function renderChart(dataObj) {
            const ctx = document.getElementById('expenseChart').getContext('2d');
            
            // æª¢æŸ¥æ˜¯å¦æœ‰æ•¸æ“š
            const hasData = Object.values(dataObj).some(val => val > 0);
            
            // éŠ·æ¯€èˆŠåœ–è¡¨
            if (myChart) myChart.destroy();

            const chartData = hasData ? [dataObj['å›ºå®šæ”¯å‡º'], dataObj['è®Šå‹•æ”¯å‡º'], dataObj['é å­˜æ”¯å‡º']] : [1];
            const chartColors = hasData ? ['#5a4d41', '#b08d85', '#d4a373'] : ['#eee']; // ç„¡æ•¸æ“šé¡¯ç¤ºç°è‰²
            const chartLabels = hasData ? ['å›ºå®šæ”¯å‡º', 'è®Šå‹•æ”¯å‡º', 'é å­˜æ”¯å‡º'] : ['å°šç„¡æ”¯å‡º'];

            myChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        data: chartData,
                        backgroundColor: chartColors,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { padding: 20, usePointStyle: true } }
                    },
                    cutout: '70%'
                }
            });
        }

        // --- 5. è³‡æ–™å‚™ä»½èˆ‡é‚„åŸ ---
        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(transactions));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "bear_backup_" + new Date().toISOString().slice(0,10) + ".json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function importData(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    if (Array.isArray(imported)) {
                        transactions = imported;
                        saveData();
                        alert('åŒ¯å…¥æˆåŠŸï¼æ•¸æ“šå·²é‚„åŸã€‚');
                        location.reload();
                    } else {
                        alert('æ ¼å¼éŒ¯èª¤ï¼šæª”æ¡ˆå¥½åƒä¸æ˜¯ Bear çš„å‚™ä»½æª”å–”ã€‚');
                    }
                } catch(err) {
                    alert('è®€å–å¤±æ•—ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ˜¯å¦æ­£ç¢ºã€‚');
                }
            };
            reader.readAsText(file);
        }

        function clearData() {
            if(confirm('è­¦å‘Šï¼šé€™æœƒæ¸…ç©ºæ‰€æœ‰è¨˜å¸³è³‡æ–™ä¸”ç„¡æ³•å¾©åŸï¼ç¢ºå®šè¦åŸ·è¡Œå—ï¼Ÿ')) {
                localStorage.removeItem('bear_transactions');
                location.reload();
            }
        }
    </script>
</body>
</html>
